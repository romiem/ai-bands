name: Validate and Combine AI Bands JSON

on:
  push:
    branches:
      - "**"
    paths:
      - "src/**/*.json"
      - "artist.schema.json"
      - ".github/workflows/build-ai-bands-json.yml"
  pull_request:
    branches:
      - "**"
    paths:
      - "src/**/*.json"
      - "artist.schema.json"
      - ".github/workflows/build-ai-bands-json.yml"

jobs:
  validate_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed to push commits

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install dependencies (ajv)
        run: npm install ajv@8 ajv-formats

      - name: Validate and combine JSON files
        run: |
          node <<'EOF'
          const fs = require('fs');
          const Ajv = require('ajv');
          const addFormats = require('ajv-formats');

          const ajv = new Ajv({ allErrors: true });
          addFormats(ajv);

          const schema = JSON.parse(fs.readFileSync('artist.schema.json', 'utf8'));
          const validate = ajv.compile(schema);

          const files = fs.readdirSync('src').filter(f => f.endsWith('.json'));
          const combined = [];

          let hasErrors = false;

          for (const file of files) {
            const filePath = `src/${file}`;
            let raw;
            try {
              raw = fs.readFileSync(filePath, 'utf8');
            } catch (err) {
              console.error(`❌ Failed to read ${filePath}:`, err.message);
              hasErrors = true;
              continue;
            }

            let obj;
            try {
              obj = JSON.parse(raw);
            } catch (err) {
              console.error(`❌ Invalid JSON in ${filePath}:`, err.message);
              hasErrors = true;
              continue;
            }

            const valid = validate(obj);
            if (!valid) {
              console.error(`❌ Schema validation failed for ${filePath}:`);
              for (const e of validate.errors) {
                console.error(`  ${e.instancePath} ${e.message}`);
              }
              hasErrors = true;
              continue;
            }

            combined.push(obj);
          }

          if (hasErrors) {
            console.error('❌ Validation errors detected. Aborting build.');
            process.exit(1);
          }

          combined.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));

          fs.mkdirSync('dist', { recursive: true });
          fs.writeFileSync('dist/ai-bands.json', JSON.stringify(combined, null, 2));
          console.log('✅ All JSON files validated, combined, and sorted successfully.');
          EOF

      - name: Commit and push combined JSON (main branch only)
        if: github.ref == 'refs/heads/main' && success()
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "Auto-build: update combined ai-bands.json"
          file_pattern: dist/ai-bands.json
